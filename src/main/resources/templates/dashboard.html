<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.6.5/build/vanilla-js-calendar.min.css">
    <style>
        body { padding-top: 70px; }
        nav { position: fixed; top: 0; left: 0; right: 0; padding: 0 1rem; z-index: 1000; background: var(--card-background-color); border-bottom: 1px solid var(--card-border-color); }
        .habit-streak { position: relative; cursor: pointer; overflow: visible; }
        .calendar-popup { display: none; position: absolute; bottom: 125%; right: 0; background: var(--card-background-color); border: 1px solid var(--card-border-color); border-radius: var(--border-radius); box-shadow: var(--card-box-shadow); z-index: 1001; padding: 0.4rem; }
        .vanilla-js-calendar { min-width: 220px; min-height: 180px; }
        .habit-streak .calendar-popup { display: none; }
        .habit-streak .calendar-popup.visible { display: block; }
        .icon { vertical-align: middle; width: 1.1em; height: 1.1em; margin-right: 0.3em; }
        .icon-button { padding: 0.5rem 0.75rem; }
        .daily-streak-card { text-align: center; }
        .habit-actions form { margin-left: 0.5rem; }
        nav details[role="list"] { width: auto; }
        nav details[role="list"] summary { padding: 0.5rem; }
        nav details[role="list"] ul { white-space: nowrap; }
        /* Flash message styles */
        .success-flash { padding: 1rem; margin-bottom: 1rem; border-left: 5px solid var(--pico-color-green-500); background-color: var(--pico-color-green-100); color: var(--pico-color-green-700); }
        .info-flash { padding: 1rem; margin-bottom: 1rem; border-left: 5px solid var(--pico-color-blue-500); background-color: var(--pico-color-blue-100); color: var(--pico-color-blue-700); }
        .error-flash { padding: 1rem; margin-bottom: 1rem; border-left: 5px solid var(--pico-color-red-500); background-color: var(--pico-color-red-100); color: var(--pico-color-red-700); }
    </style>
</head>
<body>
<main class="container">
    <nav>
        <ul>
            <li><a href="/dashboard"><i data-feather="home" class="icon"></i><strong>Habit Tracker</strong></a></li>
        </ul>
        <ul>
            <li><a href="/dashboard" role="button" class="contrast outline"><i data-feather="check-square" class="icon"></i>Dashboard</a></li>
            <li><a href="/explore" class="secondary outline"><i data-feather="search" class="icon"></i>Explore</a></li>
            <li><a href="/friends" class="secondary outline"><i data-feather="users" class="icon"></i>Friends</a></li>
            <li><a href="/rooms" class="secondary outline"><i data-feather="grid" class="icon"></i>Habit Rooms</a></li>
            <li><a href="/account" class="secondary outline"><i data-feather="user" class="icon"></i>Account</a></li>
            <li>
                <details role="list" dir="rtl">
                    <summary aria-haspopup="listbox" role="button" class="secondary outline icon-button">
                        <i data-feather="bell"></i>
                        <span th:if="${!#lists.isEmpty(unreadNotifications)}" th:text="'(' + ${#lists.size(unreadNotifications)} + ')'" style="margin-left: -5px; color: var(--pico-primary);"></span>
                    </summary>
                    <ul role="listbox">
                        <li th:if="${#lists.isEmpty(unreadNotifications)}"><a><i>No new notifications</i></a></li>
                        <li th:each="notification : ${unreadNotifications}">
                           <a th:href="@{/notifications/{id}/read(id=${notification.id}, redirectTo=${notification.link})}" style="display: flex; align-items: center;">
                               <i data-feather="message-square" style="width: 1em; height: 1em; margin-right: 0.5em;"></i>
                               <span th:text="${notification.message}"></span>
                           </a>
                        </li>
                        <li th:if="${!#lists.isEmpty(unreadNotifications)}"><hr><a href="/notifications">View All</a></li>
                    </ul>
                </details>
            </li>
             <li>
                <form th:action="@{/logout}" method="post" style="margin-bottom: 0;">
                    <button type="submit" class="secondary outline icon-button" title="Logout"><i data-feather="log-out"></i></button>
                </form>
            </li>
        </ul>
    </nav>

    <div style="margin-top: 1rem;">
         <div th:if="${success}" role="alert" class="success-flash" th:text="${success}"></div>
         <div th:if="${info}" role="alert" class="info-flash" th:text="${info}"></div>
         <div th:if="${error}" role="alert" class="error-flash" th:text="${error}"></div>
     </div>

    <div class="grid">
        <article class="daily-streak-card">
            <h3><i data-feather="zap" class="icon"></i>Daily Streak</h3>
            <h1 style="margin: 0;" th:text="${dailyStreak != null ? dailyStreak : 0} + ' Days ðŸ”¥'">0 Days ðŸ”¥</h1>
            <small>Complete one habit daily</small>
        </article>
        <article>
            <h2><i data-feather="plus-circle" class="icon"></i>Add New Habit</h2>
            <form th:action="@{/habits}" th:object="${newHabit}" method="post">
                <input type="text" th:field="*{name}" placeholder="Habit name (e.g., Read for 15 mins)" required>
                <input type="text" th:field="*{description}" placeholder="Description (optional)">
                <button type="submit"><i data-feather="plus" class="icon"></i>Add Habit</button>
            </form>
        </article>
    </div>

    <h2 style="margin-top: 2rem;"><i data-feather="list" class="icon"></i>My Habits</h2>
    <div th:if="${#lists.isEmpty(habits)}">
        <p>You haven't added any habits yet. Add one above to get started!</p>
    </div>
    <div th:unless="${#lists.isEmpty(habits)}">
        <article th:each="habit : ${habits}" style="margin-bottom: 1rem;">
             <div style="display: flex; justify-content: space-between; align-items: center;">
                 <div>
                     <strong th:text="${habit.name}">Habit Name</strong>
                     <p th:text="${habit.description}" style="margin: 5px 0 0 0; color: var(--pico-muted-color);">Description</p>
                 </div>
                 <div style="display: flex; align-items: center;" class="habit-actions">
                     <div class="habit-streak" th:attr="data-habit-id=${habit.id}" th:title="'Click to view ' + ${habit.name} + ' calendar'">
                         <span th:text="'Streak: ' + (${streaks.get(habit.id) != null ? streaks.get(habit.id) : 0}) + ' ðŸ”¥'" style="font-weight: bold; margin-right: 1rem;"></span>
                         <div class="calendar-popup">
                             <div class="vanilla-js-calendar"></div>
                         </div>
                     </div>
                     <form th:action="@{/habits/{id}/log(id=${habit.id})}" method="post" style="display: inline-block;">
                         <button type="submit" class="outline icon-button" title="Log Completion"><i data-feather="check"></i></button>
                     </form>
                     </div>
             </div>
         </article>
    </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.6.5/build/vanilla-js-calendar.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const streakElements = document.querySelectorAll('.habit-streak[data-habit-id]');
        streakElements.forEach(element => {
            let calendarInstance = null;
            let timeoutId = null; // Store timeout ID for debouncing hover

            element.addEventListener('mouseenter', () => { // Changed to mouseenter for hover effect
                if (calendarInstance) return;

                const habitId = element.getAttribute('data-habit-id');
                const calendarContainer = element.querySelector('.vanilla-js-calendar');
                const popup = element.querySelector('.calendar-popup');
                if (!popup || !calendarContainer) return;

                // Simple debounce
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    popup.classList.add('visible'); // Show popup

                    fetch(`/api/habits/${habitId}/logs`)
                        .then(response => response.ok ? response.json() : [])
                        .then(dates => {
                            dates = Array.isArray(dates) ? dates : [];
                            try {
                                if (window.VanillaJsCalendar) { // Check if library loaded
                                    calendarInstance = new VanillaJsCalendar(calendarContainer, {
                                        settings: { selected: { dates: dates }, visibility: { daysOutside: false, monthShort: true } }
                                    });
                                } else {
                                    console.error("VanillaJsCalendar not loaded");
                                }
                            } catch(e) { console.error("Error init calendar", e); }
                        })
                        .catch(error => console.error('Error fetching calendar data:', error));
                }, 100); // 100ms delay
            });

            element.addEventListener('mouseleave', () => { // Changed to mouseleave
                clearTimeout(timeoutId); // Clear any pending fetch/render
                const popup = element.querySelector('.calendar-popup');
                const calendarContainer = element.querySelector('.vanilla-js-calendar');
                if (popup) popup.classList.remove('visible'); // Hide popup
                if (calendarInstance && calendarContainer) {
                    try { calendarContainer.innerHTML = ''; } catch(e) {} // Clear content
                    calendarInstance = null;
                }
            });

            // Optional: Add click listener for modal if needed (code removed for brevity)
        });
    });
</script>
<script src="https://unpkg.com/feather-icons"></script>
<script> feather.replace(); </script>
</body>
</html>