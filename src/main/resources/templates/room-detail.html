<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Room Details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body { padding-top: 70px; }
        nav { position: fixed; top: 0; left: 0; right: 0; padding: 0 1rem; z-index: 1000; background: var(--card-background-color); border-bottom: 1px solid var(--card-border-color); }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--pico-muted-border-color); }
        .completed { background-color: var(--pico-color-green-100); }
    </style>
</head>
<body>
<nav class="container">
    <ul>
        <li><a href="/rooms"><strong>‚Üê Back to Rooms</strong></a></li>
    </ul>
</nav>

<main class="container">
    <div th:if="${success}" style="padding: 1rem; margin-bottom: 1rem; border-left: 5px solid var(--pico-color-green-500); background: var(--pico-color-green-100); color: var(--pico-color-green-700);" th:text="${success}"></div>
    <div th:if="${error}" style="padding: 1rem; margin-bottom: 1rem; border-left: 5px solid var(--pico-color-red-500); background: var(--pico-color-red-100); color: var(--pico-color-red-700);" th:text="${error}"></div>

    <article>
        <h1 th:text="${room.habitName}">Room Name</h1>
        <p th:text="${room.description}">Room Description</p>
        <p><strong>Daily Goal:</strong> <span th:text="${room.dailyGoal}">Goal</span></p>
        <p><strong>Room Code:</strong> <code th:text="${room.roomCode}">ABC123</code></p>
        <p><strong>Current Streak:</strong> <span th:text="${room.currentStreak} + ' üî•'">0 üî•</span></p>
    </article>

    <h2>Members</h2>
    <article>
        <div th:if="${#lists.isEmpty(members)}">
            <p>No members in this room yet.</p>
        </div>
        <div th:unless="${#lists.isEmpty(members)}">
            <div th:each="member : ${members}" class="member-item" th:classappend="${member.hasCompletedToday} ? 'completed' : ''">
                <div>
                    <strong th:text="${member.user.username}">Username</strong>
                    <span th:if="${member.user.id == currentUser.id}"> (You)</span>
                </div>
                <div>
                    <span th:if="${member.hasCompletedToday}" style="color: var(--pico-color-green-500);">‚úì Completed Today</span>
                    <span th:unless="${member.hasCompletedToday}" style="color: var(--pico-muted-color);">Pending</span>
                </div>
            </div>
        </div>
    </article>

    <form th:action="@{/rooms/{code}/complete(code=${room.roomCode})}" method="post" style="margin-top: 2rem;">
        <button type="submit">Mark My Task as Complete</button>
    </form>
</main>

<!-- WebSocket for real-time updates -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script th:inline="javascript">
    const roomCode = /*[[${room.roomCode}]]*/ '';
    
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    
    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);
        
        // Subscribe to room updates
        stompClient.subscribe('/topic/room/' + roomCode, function(message) {
            const data = JSON.parse(message.body);
            console.log('Room update:', data);
            
            // Show notification
            alert(data.message);
            
            // Reload page to show updated data
            location.reload();
        });
    });
</script>
</body>
</html>